{% extends 'appstage/base.html' %}
{% load static %}

{% block title %}Dashboard administrateur{% endblock %}

{% block main %}
<div class="container py-5">

    <!-- TITRE -->
    <div class="text-center mb-5 animate-fade">
        <h2 class="fw-bold text-dark">Tableau de bord – Administration</h2>
        <p class="text-muted">Aperçu global des offres et candidatures.</p>
    </div>

    <!-- STAT CARDS -->
    <div class="row g-4 mb-5">

        <div class="col-md-3">
            <div class="card shadow-lg border-0 rounded-4 p-4 text-center bg-primary text-white animate-fade">
                <i class="bi bi-briefcase-fill fs-1 mb-2"></i>
                <h3 class="fw-bold">{{ total_offres }}</h3>
                <p class="mb-0">Total offres</p>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-lg border-0 rounded-4 p-4 text-center bg-success text-white animate-fade">
                <i class="bi bi-check-circle-fill fs-1 mb-2"></i>
                <h3 class="fw-bold">{{ offres_validees }}</h3>
                <p class="mb-0">Offres validées</p>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-lg border-0 rounded-4 p-4 text-center bg-warning text-dark animate-fade">
                <i class="bi bi-hourglass-split fs-1 mb-2"></i>
                <h3 class="fw-bold">{{ offres_attente }}</h3>
                <p class="mb-0">En attente</p>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-lg border-0 rounded-4 p-4 text-center bg-dark text-white animate-fade">
                <i class="bi bi-people-fill fs-1 mb-2"></i>
                <h3 class="fw-bold">{{ total_candidatures }}</h3>
                <p class="mb-0">Candidatures totales</p>
            </div>
        </div>

    </div>

    <!-- GRAPHIQUES -->
    <div class="row g-4">

        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-4 p-4">
                <h5 class="text-center fw-bold mb-3">Répartition des statuts</h5>
                <canvas id="chartStatut"></canvas>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-4 p-4">
                <h5 class="text-center fw-bold mb-3">Candidatures / mois</h5>
                <canvas id="chartCandidatures"></canvas>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-4 p-4">
                <h5 class="text-center fw-bold mb-3">Offres créées / mois</h5>
                <canvas id="chartOffres"></canvas>
            </div>
        </div>

    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const dataStatut = JSON.parse('{{ stats_statut|escapejs }}');
    const dataCand = JSON.parse('{{ stats_candidatures_mois|escapejs }}');
    const dataOffres = JSON.parse('{{ stats_offres_mois|escapejs }}');

    new Chart(document.getElementById('chartStatut'), {
        type: 'doughnut',
        data: {
            labels: dataStatut.map(x => x.statutOffre),
            datasets: [{
                data: dataStatut.map(x => x.total),
                backgroundColor: ['#0d6efd', '#198754', '#dc3545', '#6c757d'],
                borderWidth: 0
            }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
    });

    new Chart(document.getElementById('chartCandidatures'), {
        type: 'bar',
        data: {
            labels: dataCand.map(x => new Date(x.month).toLocaleString('fr-FR', { month: 'short' })),
            datasets: [{
                label: 'Candidatures',
                data: dataCand.map(x => x.total),
                backgroundColor: '#0d6efd',
                borderRadius: 8
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });

    new Chart(document.getElementById('chartOffres'), {
        type: 'line',
        data: {
            labels: dataOffres.map(x => new Date(x.month).toLocaleString('fr-FR', { month: 'short' })),
            datasets: [{
                label: 'Offres',
                data: dataOffres.map(x => x.total),
                borderColor: '#198754',
                borderWidth: 3,
                tension: .3,
                fill: false
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });
</script>
{% endblock %}
