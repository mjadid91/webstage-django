{% extends 'appstage/base.html' %}
{% load static %}

{% block title %}Offres de stage | AppStage{% endblock %}

{% block main %}
<div class="container py-5">

    <!-- TITRE + SOUS-TITRE -->
    <div class="text-center mb-5 animate-fade">
        <h2 class="fw-bold text-dark mb-2">
            {% if request.user.is_superuser %}
                Toutes les offres
            {% elif request.user.is_staff %}
                Gestion des offres
            {% else %}
                Stages disponibles
            {% endif %}
            <span class="badge bg-primary rounded-pill ms-2">{{ offres|length }}</span>
        </h2>
        <p class="text-muted">Explorez les opportunit√©s et propulsez votre carri√®re.</p>
    </div>

    <!-- BARRE DE RECHERCHE -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="card p-4 shadow-sm rounded-4">

                <form method="GET" class="row g-3 align-items-center">

                    <!-- Champ de recherche -->
                    <div class="col-md-{% if request.user.is_staff or request.user.is_superuser %}6{% else %}9{% endif %}">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 text-muted">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" name="q" class="form-control border-start-0"
                                   placeholder="Poste, entreprise, comp√©tences..." value="{{ q }}">
                        </div>
                    </div>

                    <!-- Filtre statut (admin/staff) -->
                    {% if request.user.is_superuser or request.user.is_staff %}
                    <div class="col-md-3">
                        <select name="statut" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option value="attente" {% if statut == 'attente' %}selected{% endif %}>üïí En attente</option>
                            <option value="validee" {% if statut == 'validee' %}selected{% endif %}>‚úÖ Valid√©e</option>
                            <option value="refusee" {% if statut == 'refusee' %}selected{% endif %}>‚ùå Refus√©e</option>
                        </select>
                    </div>
                    {% endif %}

                    <!-- Bouton rechercher -->
                    <div class="col-md-3 d-grid">
                        <button class="btn btn-primary fw-bold py-2">
                            Rechercher
                        </button>
                    </div>

                </form>

            </div>
        </div>
    </div>

    <!-- AUCUN R√âSULTAT -->
    {% if offres|length == 0 %}
        <div class="text-center py-5">
            <i class="bi bi-search display-1 text-muted opacity-25"></i>
            <h4 class="mt-3 text-secondary">Aucun r√©sultat trouv√©</h4>
            <p class="text-muted">Essayez de modifier vos crit√®res de recherche.</p>
            <a href="/offres/" class="btn btn-link">R√©initialiser les filtres</a>
        </div>

    {% else %}

    <!-- LISTE DES OFFRES -->
    <div class="row g-4">
        {% for offre in offres %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 offer-card shadow-sm rounded-4 animate-fade">

                <!-- Image + Badge -->
                <div class="position-relative overflow-hidden">
                    <img src="{% if offre.imageOffre %}{{ offre.imageOffre.url }}{% else %}{% static 'appstage/img/default_offer.jpg' %}{% endif %}"
                         class="card-img-top offer-img" alt="{{ offre.titreOffre }}">

                    <div class="position-absolute top-0 start-0 m-3">
                        {% if offre.statutOffre == 'validee' %}
                            <span class="badge bg-success shadow-sm px-3 py-2">Valid√©e</span>
                        {% elif offre.statutOffre == 'refusee' %}
                            <span class="badge bg-danger shadow-sm px-3 py-2">Refus√©e</span>
                        {% else %}
                            <span class="badge bg-warning text-dark shadow-sm px-3 py-2">En attente</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Contenu -->
                <div class="card-body p-4 d-flex flex-column">

                    <h5 class="card-title fw-bold text-dark text-truncate mb-1">{{ offre.titreOffre }}</h5>

                    <p class="text-primary fw-medium mb-3 small">
                        <i class="bi bi-building me-1"></i> {{ offre.entrepriseOffre }}
                    </p>

                    <div class="text-muted small mb-4">
                        <i class="bi bi-calendar3 me-2"></i>
                        Post√© le {{ offre.dateDepotOffre|date:"d F Y" }}
                    </div>

                    <!-- Progression candidatures (admin/staff) -->
                    {% if request.user.is_staff or request.user.is_superuser %}
                    <div class="bg-light rounded-3 p-3 mb-4">
                        <div class="d-flex justify-content-between small fw-bold mb-1">
                            <span>Candidatures</span>
                            <span>{{ offre.nb_candidatures }} / 5</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar
                                {% if offre.nb_candidatures >= 5 %}bg-danger
                                {% elif offre.nb_candidatures >= 3 %}bg-warning
                                {% else %}bg-success{% endif %}"
                                role="progressbar"
                                style="width: calc({{ offre.nb_candidatures }} * 20%);">
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex gap-2 mt-auto">
                        <a href="/offres/{{ offre.IDOffre }}/" class="btn btn-outline-primary w-100 fw-bold">
                            Voir d√©tails
                        </a>

                        {% if request.user.is_superuser or request.user.is_staff %}
                        <div class="dropdown">
                            <button class="btn btn-light border" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><a class="dropdown-item text-success fw-bold" href="/offres/{{ offre.IDOffre }}/valider/"><i class="bi bi-check-circle me-2"></i>Valider</a></li>
                                <li><a class="dropdown-item text-danger fw-bold" href="/offres/{{ offre.IDOffre }}/refuser/"><i class="bi bi-x-circle me-2"></i>Refuser</a></li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% endif %}
</div>
{% endblock %}
