{% extends 'appstage/base.html' %}
{% load static %}

{% block title %}Offres de stage{% endblock %}

{% block main %}
<div class="container mt-4">

    <h3 class="text-center mb-4 fw-bold">
        {% if request.user.is_superuser %}
            Toutes les offres ({{ offres|length }})
        {% elif request.user.is_staff %}
            Offres en attente ({{ offres|length }})
        {% else %}
            Offres disponibles ({{ offres|length }})
        {% endif %}
    </h3>

    <!-- BARRE DE RECHERCHE -->
    <form method="GET" class="row mb-4">

        <!-- Recherche texte -->
        <div class="col-md-8">
            <input 
                type="text" 
                name="q" 
                class="form-control"
                placeholder="Rechercher un stage (titre, entreprise)..."
                value="{{ q }}"
            >
        </div>

        <!-- Filtre statut (staff + admin seulement) -->
        {% if request.user.is_superuser or request.user.is_staff %}
        <div class="col-md-3">
            <select name="statut" class="form-select">
                <option value="">Tous les statuts</option>
                <option value="attente"  {% if statut == 'attente' %}selected{% endif %}>En attente</option>
                <option value="validee"  {% if statut == 'validee' %}selected{% endif %}>Validée</option>
                <option value="refusee"  {% if statut == 'refusee' %}selected{% endif %}>Refusée</option>
                <option value="cloturee" {% if statut == 'cloturee' %}selected{% endif %}>Clôturée</option>
            </select>
        </div>
        {% endif %}

        <!-- Bouton -->
        <div class="col-md-1">
            <button class="btn btn-primary w-100">
                <i class="bi bi-search"></i>
            </button>
        </div>

    </form>

    {% if offres|length == 0 %}
        <h5 class="text-center text-muted">Aucune offre disponible.</h5>

    {% else %}

    <div class="row g-4">

        {% for offre in offres %}
        <div class="col-md-4">
            <div class="card shadow-sm offer-card h-100">

                <!-- IMAGE -->
                {% if offre.imageOffre %}
                    <img src="{{ offre.imageOffre.url }}"
                         class="card-img-top offer-img"
                         alt="Image de l'offre">
                {% else %}
                    <img src="{% static 'appstage/img/default_offer.jpg' %}"
                         class="card-img-top offer-img"
                         alt="Image par défaut">
                {% endif %}

                <div class="card-body">

                    <!-- TITRE -->
                    <h5 class="card-title fw-bold">{{ offre.titreOffre }}</h5>

                    <!-- ORGANISME -->
                    <p class="text-muted mb-1">
                        <i class="bi bi-building"></i> {{ offre.entrepriseOffre }}
                    </p>

                    <!-- DATE -->
                    <p class="small text-secondary">
                        Publiée le {{ offre.dateDepotOffre|date:"d M Y" }}
                    </p>

                    <!-- STATUT BADGE -->
                    {% if offre.statutOffre == 'validee' %}
                        <span class="badge bg-success">Validée</span>
                    {% elif offre.statutOffre == 'refusee' %}
                        <span class="badge bg-danger">Refusée</span>
                    {% elif offre.statutOffre == 'attente' %}
                        <span class="badge bg-warning text-dark">En attente</span>
                    {% elif offre.statutOffre == 'cloturee' %}
                        <span class="badge bg-secondary">Clôturée</span>
                    {% endif %}

                    <!-- COMPTEUR CANDIDATURES (STAFF + ADMIN) -->
                    {% if request.user.is_staff or request.user.is_superuser %}
                    <p class="mt-2 fw-bold">
                        <i class="bi bi-people"></i>
                        {{ offre.nb_candidatures }} / 5 candidatures reçues
                    </p>

                    <!-- Barre de progression -->
                    <div class="progress mb-2" style="height: 7px;">
                        <div class="progress-bar 
                            {% if offre.nb_candidatures < 3 %}
                                bg-success
                            {% elif offre.nb_candidatures < 5 %}
                                bg-warning
                            {% else %}
                                bg-danger
                            {% endif %}"
                            role="progressbar"
                            style="width: calc({{ offre.nb_candidatures }} * 20%);">
                        </div>
                    </div>
                    {% endif %}

                    <hr>

                    <!-- BOUTONS -->
                    <div class="d-flex justify-content-between">
                        <a href="/offres/{{ offre.IDOffre }}/" class="btn btn-primary btn-sm">
                            Voir détails
                        </a>

                        {% if request.user.is_superuser or request.user.is_staff %}
                            <a href="/offres/{{ offre.IDOffre }}/valider/" class="btn btn-success btn-sm">
                                Valider
                            </a>

                            <a href="/offres/{{ offre.IDOffre }}/refuser/" class="btn btn-danger btn-sm">
                                Refuser
                            </a>
                        {% endif %}
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}

    </div>
    {% endif %}
</div>

{% endblock %}
